name: dracula-distributed-system

services:
  # --- 1. GATEWAY (Mimics K8s Ingress) ---
  gateway:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - main-page
      - auth-service
      - consumet-api
      - comment-service
    networks:
      - dracula-net

  # --- 2. AUTHENTICATION SERVICE ---
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    environment:
      # Database
      DATABASE_URL: "postgresql://admin:qazwsxedc@postgres:5432/ds_movie_auth?sslmode=disable"
      # Auth Config
      BETTER_AUTH_SECRET: "+wfdi7ySpvoTBBAxIAVyr1nwN9XmG5NS/hOatv/6VR8="
      BETTER_AUTH_URL: "http://auth.dracula.com"
      BETTER_AUTH_TRUSTED_ORIGINS: "http://dracula.com,http://auth.dracula.com"
      # Google OAuth (Replace with real values)
      GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID}"
      GOOGLE_CLIENT_SECRET: "${GOOGLE_CLIENT_SECRET}"
    depends_on:
      - postgres
    networks:
      - dracula-net

  # --- 3. MAIN PAGE (FRONTEND) ---
  main-page:
    build:
      context: ./main-page
      dockerfile: Dockerfile
    environment:
      # Client-side (Browser sees this)
      NEXT_PUBLIC_BETTER_AUTH_URL: "http://auth.dracula.com"
      # Server-side (Container sees this)
      INTERNAL_AUTH_URL: "http://auth-service:3000"
      BETTER_AUTH_URL: "http://auth.dracula.com"
    depends_on:
      - auth-service
    networks:
      - dracula-net

  # --- 4. DATA API (Consumet) ---
  consumet-api:
    build:
      context: ./consumet-api
      dockerfile: Dockerfile
    environment:
      PORT: 8000
      REDIS_HOST: "redis"
      REDIS_PORT: 6379
    depends_on:
      - redis
    networks:
      - dracula-net

  # --- 5. COMMENT SERVICE (Go) ---
  comment-service:
    build:
      context: ./comment-service
      dockerfile: Dockerfile
    environment:
      SERVICE_PORT: "8080"
      MONGO_URI: "mongodb://mongo:27017"
      MONGO_DB: "dracula_comments"
      MONGO_COLLECTION: "comments"
      KAFKA_BROKERS: "kafka:9092"
      KAFKA_TOPIC_COMMENT_CREATED: "comments.created"
      KAFKA_TOPIC_COMMENT_REPLIED: "comments.replied"
    depends_on:
      - mongo
      - kafka
    networks:
      - dracula-net

  # --- INFRASTRUCTURE: POSTGRES ---
  postgres:
    image: postgres:17.6
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: qazwsxedc
      POSTGRES_DB: ds_movie_auth
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - dracula-net

  # --- INFRASTRUCTURE: REDIS ---
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - dracula-net

  # --- INFRASTRUCTURE: MONGODB ---
  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    networks:
      - dracula-net

  # --- INFRASTRUCTURE: KAFKA (KRaft Mode) ---
  kafka:
    image: apache/kafka:3.7.0
    environment:
      # KRaft Settings
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - dracula-net

volumes:
  postgres_data:
  redis_data:
  mongo_data:
  kafka_data:

networks:
  dracula-net:
    driver: bridge
